<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Property Search Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div class="max-w-4xl mx-auto p-6">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">ğŸ  AI Property Search Test</h1>
            <p class="text-gray-600">Testing connection to backend AI chat service</p>
        </div>

        <!-- Messages Container -->
        <div id="messages" class="space-y-4 mb-32"></div>

        <!-- Chat Input (Fixed Bottom) -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4">
            <div class="max-w-4xl mx-auto">
                <form id="chatForm" class="flex gap-2">
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Ask about properties..."
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    />
                    <button
                        type="submit"
                        class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold"
                    >
                        Send
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const chatForm = document.getElementById('chatForm');
        const messageInput = document.getElementById('messageInput');

        // Add message to UI
        function addMessage(role, text, properties = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] rounded-lg p-4 ${
                role === 'user'
                    ? 'bg-indigo-600 text-white'
                    : 'bg-white shadow-md text-gray-900'
            }`;

            // Message text
            const textP = document.createElement('p');
            textP.textContent = text;
            bubble.appendChild(textP);

            // Properties
            if (properties && properties.length > 0) {
                const propsDiv = document.createElement('div');
                propsDiv.className = 'mt-4 space-y-2';

                properties.forEach(property => {
                    const propCard = document.createElement('div');
                    propCard.className = 'bg-gray-50 rounded-lg p-3 text-sm';
                    propCard.innerHTML = `
                        <h3 class="font-semibold">${property.title}</h3>
                        <p class="text-gray-600">ğŸ“ ${property.location}</p>
                        <p class="text-indigo-600 font-bold">ğŸ’° ${property.price}</p>
                        ${property.bedrooms ? `<p class="text-gray-500 text-xs">ğŸ›ï¸ ${property.bedrooms} bed â€¢ ğŸš¿ ${property.bathrooms} bath</p>` : ''}
                    `;
                    propsDiv.appendChild(propCard);
                });

                bubble.appendChild(propsDiv);
            }

            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Send message to backend
        async function sendMessage(message) {
            try {
                addMessage('user', message);

                const response = await fetch('/api/ai-chat/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage('assistant', data.message, data.properties || []);
                } else {
                    addMessage('assistant', 'Error: ' + (data.message || 'Failed to get response'));
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('assistant', 'Error: Failed to connect to server. Make sure backend is running on http://localhost:5000');
            }
        }

        // Form submission
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                sendMessage(message);
                messageInput.value = '';
            }
        });

        // Load greeting on page load
        (async function loadGreeting() {
            try {
                console.log('Loading greeting...');
                const response = await fetch('/api/ai-chat/greeting');
                console.log('Greeting response status:', response.status);
                const data = await response.json();
                console.log('Greeting data:', data);

                if (data.success && data.message) {
                    addMessage('assistant', data.message);
                } else {
                    addMessage('assistant', 'Hello! I can help you find properties in Kenya. What are you looking for?');
                }
            } catch (error) {
                console.error('Failed to load greeting:', error);
                addMessage('assistant', 'Hello! I can help you find properties in Kenya. What are you looking for?');
            }
        })();
    </script>
</body>
</html>
